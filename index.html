<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>C-TRAN Wait Time Heatmap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body,
      #map {
        height: 100%;
      }
      .loading {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: #111;
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font: 12px system-ui, sans-serif;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }
      .leaflet-control.legend {
        background: #fff;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        font: 12px/1.25 system-ui, sans-serif;
        color: #222;
        min-width: 180px;
      }
      .legend h4 {
        font-size: 13px;
        margin-bottom: 6px;
      }
      .legend .ramp {
        height: 10px;
        width: 160px;
        border-radius: 6px;
        margin: 6px 0 6px;
        background: linear-gradient(to right, #3fb950, #f2e34b, #d73a49);
      }
      .legend .labels {
        display: flex;
        justify-content: space-between;
      }
      .legend .sizes {
        display: flex;
        align-items: flex-end;
        gap: 14px;
        margin-top: 8px;
      }
      .legend .sizes .dot {
        display: block;
        border-radius: 50%;
        background: #222;
        opacity: 0.2;
      }
      .legend .sizes .lab {
        text-align: center;
        margin-top: 4px;
        color: #444;
      }
      .tooltip {
        position: absolute;
        pointer-events: none;
        background: rgba(0, 0, 0, 0.88);
        color: #fff;
        padding: 6px 8px;
        border-radius: 6px;
        font: 12px system-ui, sans-serif;
        white-space: nowrap;
        transform: translate(-50%, -120%);
        opacity: 0;
        transition: opacity 0.12s ease-out;
        z-index: 10000;
      }
      .info-panel {
        position: absolute;
        right: 14px;
        top: 70px;
        width: 260px;
        background: #fff;
        border-radius: 12px;
        padding: 12px 12px 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
        font: 13px/1.35 system-ui, sans-serif;
        color: #1a1a1a;
        z-index: 1200;
        display: none;
      }
      .info-panel .row {
        display: flex;
        justify-content: space-between;
        margin: 6px 0;
      }
      .info-panel h3 {
        font-size: 15px;
        margin-bottom: 8px;
      }
      .info-panel .pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        background: #f2f4f7;
        font-size: 12px;
        color: #333;
        margin-left: 6px;
      }
      .info-panel .close {
        position: absolute;
        top: 8px;
        right: 8px;
        border: 0;
        background: transparent;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        color: #666;
      }
      .info-panel .meter {
        height: 6px;
        width: 100%;
        border-radius: 999px;
        background: #eef0f3;
        margin-top: 8px;
        overflow: hidden;
      }
      .info-panel .meter > div {
        height: 100%;
        background: linear-gradient(90deg, #3fb950, #f2e34b, #d73a49);
      }
      svg .bubble {
        pointer-events: none;
      }
      svg .hit {
        fill: rgba(0, 0, 0, 0.001);
        cursor: pointer;
        pointer-events: all;
      }
      svg text.stop-label {
        font: 11px system-ui, sans-serif;
        fill: #111;
        paint-order: stroke;
        stroke: #fff;
        stroke-width: 3px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s linear;
      }
      g.labels-visible text.stop-label {
        opacity: 0.85;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="loading" class="loading">Loading stops...</div>
    <div id="tooltip" class="tooltip"></div>

    <aside id="panel" class="info-panel">
      <button id="panelClose" class="close" title="Close">x</button>
      <h3 id="panelTitle">Stop</h3>
      <div class="row">
        <span>Wait (avg)</span><strong id="panelWait">-</strong>
      </div>
      <div class="row"><span>Rank</span><strong id="panelRank">-</strong></div>
      <div class="row">
        <span>Percentile</span><strong id="panelPct">-</strong>
      </div>
      <div class="meter"><div id="panelMeter" style="width: 0%"></div></div>
      <div style="margin-top: 10px; color: #555">Higher bar = longer waits</div>
    </aside>

    <script>
      const map = L.map("map").setView([45.64, -122.66], 12);

      const street = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 19,
        }
      ).addTo(map);

      const dark = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "© CARTO, OSM",
        }
      );

      L.control.layers({ Street: street, Dark: dark }).addTo(map);

      const svgLayer = L.svg({ clickable: true }).addTo(map);
      const g = d3.select(svgLayer._container).select("g");

      const tooltip = d3.select("#tooltip");
      const panelEl = document.getElementById("panel");
      const panelTitle = document.getElementById("panelTitle");
      const panelWait = document.getElementById("panelWait");
      const panelRank = document.getElementById("panelRank");
      const panelPct = document.getElementById("panelPct");
      const panelMeter = document.getElementById("panelMeter");
      document.getElementById("panelClose").onclick = closePanel;
      map.on("click", closePanel);

      function openPanel() {
        panelEl.style.display = "block";
      }
      function closePanel() {
        panelEl.style.display = "none";
      }

      function debounce(fn, wait = 50) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      d3.csv("wait_time_per_stop.csv")
        .then((raw) => {
          document.getElementById("loading").style.display = "none";

          const data = raw
            .map((d) => ({
              stop_id: d.stop_id ?? `${d.stop_lat},${d.stop_lon}`,
              lat: +d.stop_lat,
              lon: +d.stop_lon,
              wait: +d.wait_time,
            }))
            .filter(
              (d) =>
                Number.isFinite(d.lat) &&
                Number.isFinite(d.lon) &&
                Number.isFinite(d.wait)
            );

          const waits = data.map((d) => d.wait).sort((a, b) => a - b);
          const minWait = d3.min(waits),
            maxWait = d3.max(waits);
          const meanWait = d3.mean(waits);
          const q1 = d3.quantile(waits, 0.25),
            q3 = d3.quantile(waits, 0.75);

          const color = d3
            .scaleLinear()
            .domain([minWait, meanWait, maxWait])
            .range(["#3fb950", "#f2e34b", "#d73a49"])
            .clamp(true);

          const baseRadius = d3
            .scaleSqrt()
            .domain([minWait, maxWait])
            .range([3, 33]);

          function zoomRadius(wait) {
            return baseRadius(wait) * Math.pow(2, map.getZoom() - 12);
          }

          function project(lat, lon) {
            const p = map.latLngToLayerPoint([lat, lon]);
            return { x: p.x, y: p.y };
          }

          const groups = g
            .selectAll("g.stop")
            .data(data, (d) => d.stop_id)
            .join((enter) => {
              const s = enter.append("g").attr("class", "stop");
              s.append("circle")
                .attr("class", "bubble")
                .attr("stroke", "rgba(0,0,0,0.25)")
                .attr("stroke-width", 1)
                .attr("fill-opacity", 0.75);
              s.append("circle").attr("class", "hit");
              s.append("text")
                .attr("class", "stop-label")
                .text((d) => d.stop_id);
              return s;
            });

          function render() {
            const labelsVisible = map.getZoom() >= 15;
            g.classed("labels-visible", labelsVisible);

            groups.each(function (d) {
              const p = project(d.lat, d.lon);
              const r = zoomRadius(d.wait);

              d3.select(this)
                .select(".bubble")
                .attr("cx", p.x)
                .attr("cy", p.y)
                .attr("r", r)
                .attr("fill", color(d.wait));

              d3.select(this)
                .select(".hit")
                .attr("cx", p.x)
                .attr("cy", p.y)
                .attr("r", Math.max(14, r * 0.8));

              d3.select(this)
                .select(".stop-label")
                .attr("x", p.x)
                .attr("y", p.y - (r + 6));
            });
          }

          const debouncedRender = debounce(render, 30);
          map.on("move", debouncedRender);
          map.on("zoom", debouncedRender);
          map.on("resize", debouncedRender);
          render();

          groups
            .select(".hit")
            .on("mousemove", function (event, d) {
              tooltip
                .style("left", event.pageX + "px")
                .style("top", event.pageY - 10 + "px")
                .style("opacity", 1)
                .html(
                  `<strong>Stop ${
                    d.stop_id
                  }</strong><br/>Avg wait: <strong>${d.wait.toFixed(
                    1
                  )} min</strong>`
                );
            })
            .on("mouseleave", function () {
              tooltip.style("opacity", 0);
            })
            .on("click", function (event, d) {
              event.stopPropagation();

              const rankIndex = d3.bisectLeft(waits, d.wait);
              const rank = rankIndex + 1;
              const pct = 100 * (rankIndex / (waits.length - 1));
              panelTitle.textContent = `Stop ${d.stop_id}`;
              panelWait.textContent = `${d.wait.toFixed(2)} min`;
              panelRank.textContent = `${rank} of ${waits.length}`;
              panelPct.textContent = `${pct.toFixed(1)}%`;
              panelMeter.style.width = `${pct}%`;
              openPanel();

              L.popup()
                .setLatLng([d.lat, d.lon])
                .setContent(
                  `<div style="font:13px system-ui,sans-serif;"><strong>Stop ${
                    d.stop_id
                  }</strong><br>Avg wait: <strong>${d.wait.toFixed(
                    1
                  )} min</strong></div>`
                )
                .openOn(map);
            });

          const Legend = L.Control.extend({
            options: { position: "bottomleft" },
            onAdd: function () {
              const div = L.DomUtil.create("div", "legend leaflet-control");
              div.innerHTML = `
              <h4>Wait time</h4>
              <div class="ramp"></div>
              <div class="labels">
                <span>${minWait.toFixed(1)}m</span>
                <span>avg ${meanWait.toFixed(1)}m</span>
                <span>${maxWait.toFixed(1)}m</span>
              </div>
              <div class="sizes">
                <div style="text-align:center;">
                  <span class="dot" style="width:${
                    baseRadius(q1) * 2
                  }px;height:${baseRadius(q1) * 2}px;"></span>
                  <div class="lab">${(q1 ?? minWait).toFixed(1)}m</div>
                </div>
                <div style="text-align:center;">
                  <span class="dot" style="width:${
                    baseRadius(meanWait) * 2
                  }px;height:${baseRadius(meanWait) * 2}px;"></span>
                  <div class="lab">${meanWait.toFixed(1)}m</div>
                </div>
                <div style="text-align:center;">
                  <span class="dot" style="width:${
                    baseRadius(q3) * 2
                  }px;height:${baseRadius(q3) * 2}px;"></span>
                  <div class="lab">${(q3 ?? maxWait).toFixed(1)}m</div>
                </div>
              </div>
            `;
              L.DomEvent.disableClickPropagation(div);
              return div;
            },
          });
          map.addControl(new Legend());
        })
        .catch((err) => {
          const el = document.getElementById("loading");
          el.textContent = "Failed to load data";
          console.error(err);
        });
    </script>
  </body>
</html>
